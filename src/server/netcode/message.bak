import { Sanitizer } from "../../shared/util/sanitizer";

/**
 * @deprecated
 */
export class Message {
    isClean: boolean;
    event: number;
    data: any;

    constructor(jsonStr: string) {
        delete this.isClean;
        delete this.event;
        delete this.data;
        this.process(jsonStr);
    }

    process(jsonStr) {
        const message = this.sanitize(jsonStr);
        if (message) {
            this.isClean = true;
            this.event = message.event;
            this.data = message.data;
        }
    }

    sanitize(jsonStr) {
        const sanitizer = new Sanitizer(jsonStr).assertStringOfLength(3, 512).assertJSON();
        if (!sanitizer.valid()) {
            return null;
        }

        const messageJson = sanitizer.json();
        const arrayValidator = new Sanitizer(messageJson).assertArrayLengthBetween(1, 20);
        if (!arrayValidator.valid()) {
            return null;
        }

        const eventNumberValidator = new Sanitizer(messageJson[0]).assertType("number");
        if (!eventNumberValidator.valid()) {
            return null;
        }

        // TODO: validate whether the message only contains a certain subset of types (str, int, arr)

        return {
            event: eventNumberValidator.getValueOr(-1),
            data: messageJson.slice(1), // Validate in event listener.
        };
    }
}
